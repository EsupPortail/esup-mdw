-- phpMyAdmin SQL Dump
-- version 4.0.10.10
-- http://www.phpmyadmin.net
--
-- Version du serveur: 5.5.34-log
-- Version de PHP: 5.3.3


-- ESUP-Portail MONDOSSIERWEB - Copyright (c) 2016 ESUP-Portail consortium
-- Base de donnees: `mdw`
--

-- --------------------------------------------------------

-- creation table des categories de preferences
CREATE TABLE IF NOT EXISTS `PREFERENCES_APPLICATION_CATEGORIE` (
  `CAT_ID` INT(11) NOT NULL,
  `CAT_DESC` text NOT NULL,
  `ORDRE` INT(11) NOT NULL,
  PRIMARY KEY (`CAT_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- creation de la table contenant les valeurs des application
CREATE TABLE IF NOT EXISTS `PREFERENCES_APPLICATION_VALEURS` (
	`PAV_ID` INT(11) NOT NULL AUTO_INCREMENT,
  `PREF_ID` varchar(40) NULL,
  `VALEUR` varchar(200) NULL,
  PRIMARY KEY (`PAV_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

ALTER TABLE `PREFERENCES_APPLICATION_VALEURS`
  ADD CONSTRAINT `FK_PREF_APP_VALEURS_ID` FOREIGN KEY (`PREF_ID`) REFERENCES `PREFERENCES_APPLICATION` (`PREF_ID`);
  
-- ajout 2 colonnes dans tables des preferences
ALTER TABLE `PREFERENCES_APPLICATION` ADD `TYPE` VARCHAR(10) NOT NULL , ADD `CAT_ID` INT NOT NULL ;

-- creation des categories
INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('1', 'Administration', '1');

INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('2', 'Notes et résultats', '2');

INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('3', 'Calendrier des examens', '3');

INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('4', 'Certificat de scolarité', '4');

INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('5', 'Informations personnelles', '5');

INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('6', 'Adresses étudiantes', '6');

INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('7', 'Assistance', '7');

INSERT INTO `PREFERENCES_APPLICATION_CATEGORIE` (`CAT_ID`, `CAT_DESC`, `ORDRE`) 
VALUES ('8', 'Extractions', '8');

-- Mise a jour des 2 nouvelles colonnes de la table des preferences pour chaque preference
UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '6' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affAdressesEnseignants';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affBaremeEtudiant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '3' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affCalendrierEpreuvesEnseignants';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '3' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affCalendrierEpreuvesEtudiants';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '3' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affDetailExamen';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affECTSEtudiant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'afficherBoutonCertifNouvelleLigne';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'afficherRangEtudiant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '5' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affInfosAnnuellesEnseignants';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '5' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affInfosContactEnseignants';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affMentionEtudiant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '3' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'affNumPlaceExamen';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '1' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'applicationActive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '1' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'applicationMobileActive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '7' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'assistanceContactMail';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '7' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'assistanceDocUrl';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '7' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'assistanceHelpdeskUrl';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certificatScolaritePDF';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certificatScolaritePJinvalide';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certificatScolariteTouteAnnee';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolAutorisePersonnel';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolCGEDesactive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolCmpDesactive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolCodeSignataire';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolFooter';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolHeaderUniv';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolLieuEdition';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolProfilDesactive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolStatutDesactive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolTampon';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolTypDiplomeDesactive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '4' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'certScolUtiliseLogo';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'codesEtapeAffichageRang';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '5' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'extensionMailEtudiant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '8' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'insertionFiligranePdfNotes';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '1' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'listeLoginsBloques';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '8' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'logoUniversitePdf';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '1' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'logoutCasPropose';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '6' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'modificationAdresses';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '5' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'modificationCoordonneesContactPerso';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'notesNombreAnneesExtractionApogee';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '8' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'notesPDF';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '8' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'notesPDFFormatPortrait';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '8' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'notesPDFLieuEdition';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '8' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'notesPDFSignature';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '1' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'partieEnseignantActive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '1' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'partieEtudiantActive';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'BOOLEAN', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'temNotesEtuSem';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'temoinCtlValCadEpr';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'temoinEtatIaeNotesEnseignant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'temoinEtatIaeNotesEtudiant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'temoinFictif';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'temoinNotesEnseignant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'temoinNotesEtudiant';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'STRING', `CAT_ID` = '8' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'trombiMobileNbEtuParPage';

UPDATE `PREFERENCES_APPLICATION` SET `TYPE` = 'LIST', `CAT_ID` = '2' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'typesEpreuveAffichageNote';

UPDATE `PREFERENCES_APPLICATION` SET `PREF_DESC` = 'Liste des logins à bloquer' WHERE `PREFERENCES_APPLICATION`.`PREF_ID` = 'listeLoginsBloques';

-- migration des preferences existantes
delimiter $$

DROP PROCEDURE IF EXISTS MIGRATELISTPARAMETERS $$

CREATE PROCEDURE MIGRATELISTPARAMETERS()
BEGIN

DECLARE num_rows INT DEFAULT 0;
DECLARE vstrdelim INT DEFAULT 0;
DECLARE vdelimpos INT DEFAULT 1;
DECLARE vdeliminf INT DEFAULT 0;
DECLARE vdelimsup INT DEFAULT 0;
DECLARE vid varchar(40);
DECLARE no_more_rows BOOLEAN;
DECLARE vvalue varchar(200);
DECLARE cur1 CURSOR FOR SELECT PREFERENCES_APPLICATION.PREF_ID, PREFERENCES_APPLICATION.VALEUR, INSTR(PREFERENCES_APPLICATION.VALEUR,',') FROM PREFERENCES_APPLICATION WHERE TYPE='LIST' AND PREFERENCES_APPLICATION.VALEUR IS NOT NULL AND PREFERENCES_APPLICATION.VALEUR <> ''; 
DECLARE CONTINUE HANDLER FOR NOT FOUND SET no_more_rows = TRUE;

OPEN cur1;
select FOUND_ROWS() into num_rows;

the_loop: LOOP
	FETCH cur1 INTO vid, vvalue,vstrdelim;
	
	-- On sort de la boucle si plus de ligne a traiter
	IF no_more_rows THEN
        CLOSE cur1;
        LEAVE the_loop;
    END IF;
	
    IF (vstrdelim > 0) THEN
    	-- il y a un delimiteur
    	WHILE(LOCATE(',',vvalue,vdelimpos)>0) DO
    		SET vdeliminf = vdelimpos;
    		SET vdelimsup = LOCATE(',',vvalue,vdeliminf);
    		IF(vdelimsup = 0) THEN
    			SET vdelimsup = LENGTH(vvalue);
    		END IF;
    	
    		INSERT INTO PREFERENCES_APPLICATION_VALEURS(PREF_ID,VALEUR) VALUES (vid,SUBSTRING(vvalue,vdeliminf,vdelimsup - vdeliminf));
    		SET vdelimpos = vdelimsup + 1;
    	END WHILE;
    	INSERT INTO PREFERENCES_APPLICATION_VALEURS(PREF_ID,VALEUR) VALUES (vid,SUBSTRING(vvalue,vdelimpos,LENGTH(vvalue) + 1 - vdelimpos));
    ELSE
      -- cas sans delimiteur
     INSERT INTO PREFERENCES_APPLICATION_VALEURS(PREF_ID,VALEUR) VALUES (vid,vvalue);
    END IF;
	
	SET vid='';
	SET vvalue='';
	SET vdelimpos=1;
	SET vdeliminf = 0;
    SET vdelimsup = 0;
	
END LOOP the_loop;

  commit;

END $$

delimiter ;

CALL MIGRATELISTPARAMETERS;

-- suppression des valeurs de liste de la table d'origine 
UPDATE PREFERENCES_APPLICATION SET VALEUR = '' WHERE TYPE='LIST';

